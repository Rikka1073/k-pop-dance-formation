# 修正記録 - 2026-02-06

## 1. ドラッグ時のカーソル位置ずれ修正

### ファイル
`src/components/editor/DraggableMemberIcon.tsx`

### 問題
エディターでメンバーをドラッグする際、マウスカーソルとメンバーアイコンの位置がずれる問題があった。

### 原因
Framer Motionの`drag`機能による要素移動と、stateによる位置更新が二重に適用されていた。

### 修正内容
Framer Motionのドラッグ機能を削除し、純粋なマウスイベント（`onMouseDown`, `mousemove`, `mouseup`）で実装し直した。

```typescript
// Before: Framer Motionのdragを使用
<motion.div drag dragMomentum={false} ... />

// After: 純粋なマウスイベントで実装
const handleMouseDown = useCallback((e: React.MouseEvent) => {
  e.preventDefault()
  e.stopPropagation()
  setIsDragging(true)
}, [])

useEffect(() => {
  if (!isDragging) return

  const handleMouseMove = (e: MouseEvent) => {
    // 親要素の座標系でパーセンテージを計算
    const rect = parent.getBoundingClientRect()
    const newX = ((e.clientX - rect.left) / rect.width) * 100
    const newY = ((e.clientY - rect.top) / rect.height) * 100
    onPositionChange(clampedX, clampedY)
  }

  window.addEventListener('mousemove', handleMouseMove)
  window.addEventListener('mouseup', handleMouseUp)
  // ...
}, [isDragging, onPositionChange])
```

---

## 2. Viewerページでフォーメーションが表示されない問題

### ファイル
`src/lib/supabase/queries.ts`

### 問題
エディターでフォーメーションを登録後、Viewerページに反映されない。データベースには正しく保存されている。

### 原因
`getFormationDataByVideoId`関数で`.single()`を使用していたため、同じ`video_id`に複数の`formation_data`が存在する場合にエラーが発生し、データ取得に失敗していた可能性がある。

### 修正内容
`.single()`を削除し、`.order('created_at', { ascending: false }).limit(1)`を使用して最新のデータを取得するように変更。

```typescript
// Before
const { data, error } = await client
  .from('formation_data')
  .select(`...`)
  .eq('video_id', videoId)
  .single()  // 複数データがあるとエラー

if (error) {
  if (error.code === 'PGRST116') return null
  throw error
}

// After
const { data, error } = await client
  .from('formation_data')
  .select(`...`)
  .eq('video_id', videoId)
  .order('created_at', { ascending: false })
  .limit(1)

if (error) {
  console.error('getFormationDataByVideoId error:', error)
  throw error
}

if (!data || data.length === 0) {
  return null
}

const result = data[0] as FullFormationData
```

---

## 3. フォーメーション初期配置の改善

### ファイル
- `src/app/editor/page.tsx`
- `src/app/editor/[videoId]/page.tsx`

### 問題
フォーメーションを追加した時の初期配置が縦一直線で見づらかった。

### 修正内容
初期配置を円形（上から時計回り）に変更。メンバー数に応じて半径を自動調整。

```typescript
// Before: 縦一直線
positions: members.map((m, idx) => ({
  memberId: m.id,
  x: 50,
  y: 30 + idx * 15,  // 縦に並ぶ
  member: m,
}))

// After: 円形配置
positions: members.map((m, index) => {
  const angle = (index / count) * 2 * Math.PI - Math.PI / 2 // 上から始める
  const radius = Math.min(25, 15 + count * 2) // メンバー数に応じて半径調整
  const x = 50 + radius * Math.cos(angle)
  const y = 50 + radius * Math.sin(angle)
  return {
    memberId: m.id,
    x: Math.round(x),
    y: Math.round(y),
    member: m,
  }
})
```

### 効果
- 4人の場合：上、右、下、左にひし形で配置
- メンバーが多くても重ならずに見やすい配置になる

---

## 4. フォーメーションがない場合のデフォルト表示

### ファイル
`src/app/viewer/[videoId]/page.tsx`

### 問題
フォーメーションデータがない場合、Viewerでメンバーが表示されない。

### 修正内容
フォーメーションがない場合は、メンバーを円形の初期位置で自動表示するようにした。

```typescript
// フォーメーションがない場合は円形の初期位置を生成
const defaultPositions = useMemo(() => {
  if (!viewerData?.members || viewerData.members.length === 0) return []
  const count = viewerData.members.length
  return viewerData.members.map((m, index) => {
    const angle = (index / count) * 2 * Math.PI - Math.PI / 2
    const radius = Math.min(25, 15 + count * 2)
    return {
      memberId: m.id,
      x: Math.round(50 + radius * Math.cos(angle)),
      y: Math.round(50 + radius * Math.sin(angle)),
    }
  })
}, [viewerData?.members])

// フォーメーションがない場合はデフォルトのフォーメーションを使用
const effectiveFormations = useMemo(() => {
  if (viewerData?.formations && viewerData.formations.length > 0) {
    return viewerData.formations
  }
  return [{
    id: 'default',
    time: 0,
    name: 'Initial Position',
    positions: defaultPositions,
  }]
}, [viewerData?.formations, defaultPositions])
```

---

## 5. formation_dataの削除機能追加

### ファイル
- `src/lib/supabase/queries.ts`
- `src/app/editor/[videoId]/page.tsx`
- `supabase/schema.sql`

### 問題
編集のたびに新しいformation_dataが作成され、データが重複していた。

### 修正内容

#### 1. 削除関数の追加 (`queries.ts`)
```typescript
export async function deleteFormationDataByVideoId(videoId: string): Promise<void> {
  const client = getSupabaseClient()
  const { error } = await client
    .from('formation_data')
    .delete()
    .eq('video_id', videoId)

  if (error) throw error
}
```

#### 2. 保存前に古いデータを削除 (`editor/[videoId]/page.tsx`)
```typescript
try {
  // Delete old formation data first
  await deleteFormationDataByVideoId(videoId)

  // Create new formation data
  const newFormationData = await createFormationData(...)
```

#### 3. RLSポリシーにDELETEを追加 (`schema.sql`)
```sql
-- Policies: Allow public delete
CREATE POLICY "Allow public delete" ON formation_data FOR DELETE USING (true);
CREATE POLICY "Allow public delete" ON formations FOR DELETE USING (true);
CREATE POLICY "Allow public delete" ON positions FOR DELETE USING (true);
```

### Supabaseで実行が必要なSQL
既存のデータベースに対して、以下のSQLを実行してください：

```sql
CREATE POLICY "Allow public delete" ON artists FOR DELETE USING (true);
CREATE POLICY "Allow public delete" ON members FOR DELETE USING (true);
CREATE POLICY "Allow public delete" ON videos FOR DELETE USING (true);
CREATE POLICY "Allow public delete" ON formation_data FOR DELETE USING (true);
CREATE POLICY "Allow public delete" ON formations FOR DELETE USING (true);
CREATE POLICY "Allow public delete" ON positions FOR DELETE USING (true);
```

---

## 6. 既存アーティスト選択機能

### ファイル
- `src/app/editor/page.tsx`
- `src/components/editor/MemberSettings.tsx`

### 問題
新規動画作成時に毎回新しいアーティストとメンバーを作成していたため、同じアーティストの別動画を登録すると重複が発生していた。

### 修正内容

#### 1. エディターページの改修 (`editor/page.tsx`)
- 起動時に既存アーティスト一覧を取得
- 「既存のアーティスト」/「新規アーティスト」の切り替えUI追加
- 既存アーティスト選択時にメンバーを自動ロード
- 保存時に既存アーティストのIDを再利用

```typescript
// 既存アーティストを取得
useEffect(() => {
  async function loadArtists() {
    const artists = await getArtists()
    setExistingArtists(artists)
  }
  loadArtists()
}, [])

// アーティスト選択時にメンバーをロード
const handleArtistSelect = (artistId: string) => {
  setSelectedArtistId(artistId)
  const artist = existingArtists.find((a) => a.id === artistId)
  if (artist) {
    setArtistName(artist.name)
    const loadedMembers = artist.members.map((m) => ({
      id: m.id, // DB IDをそのまま使用
      artistId: m.artist_id,
      name: m.name,
      color: m.color,
      order: m.display_order,
    }))
    setMembers(loadedMembers)
  }
}
```

#### 2. MemberSettingsコンポーネントの改修
- `readOnly`プロパティを追加
- 既存アーティスト選択時はメンバー編集を無効化
- 読み取り専用時は「+ Add」ボタン、削除ボタン、編集入力を非表示

### データベース構造

```
artists (アーティスト)
  ├── id, name, created_at
  │
  ├──< members (メンバー) [1:N]
  │     └── id, artist_id, name, color, display_order
  │
  └──< videos (動画) [1:N]
        └── id, artist_id, youtube_video_id, title
        │
        └──< formation_data (フォーメーションデータ) [1:N]
              └── id, video_id, contributor_name
              │
              └──< formations (フォーメーション) [1:N]
                    └── id, formation_data_id, time, name
                    │
                    └──< positions (位置) [1:N]
                          └── id, formation_id, member_id, x, y
```

### 効果
- 同じアーティストの複数動画を登録しても、アーティスト/メンバーが重複しない
- 既存アーティストを選択するとメンバーが自動入力される

---

## 7. 秒数入力フィールドの改善

### ファイル
`src/components/editor/FormationList.tsx`

### 問題
秒数入力が矢印（スピナー）クリックのみで、数字の直接入力ができずUXが悪かった。

### 修正内容

```typescript
// Before: type="number"（スピナーが邪魔）
<input
  type="number"
  value={formation.time}
  onChange={(e) => onFormationTimeChange(formation.id, parseFloat(e.target.value) || 0)}
  className="w-16 ..."
/>

// After: type="text" + バリデーション
<input
  type="text"
  inputMode="decimal"
  value={formation.time}
  onChange={(e) => {
    const value = e.target.value
    // 数字とドットのみ許可
    if (value === '' || /^\d*\.?\d*$/.test(value)) {
      const num = parseFloat(value)
      if (!isNaN(num) && num >= 0) {
        onFormationTimeChange(formation.id, num)
      }
    }
  }}
  onFocus={(e) => e.target.select()}
  className="w-20 ... focus:border-purple-500"
/>
```

### 改善点
- スピナー（矢印）を排除し、直接入力可能に
- クリック時にテキスト全選択（すぐ上書き入力できる）
- 入力幅を拡大（w-16 → w-20）
- フォーカス時にボーダーをパープルに変更
- モバイル向けに`inputMode="decimal"`追加
